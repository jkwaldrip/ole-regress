#!/usr/bin/env ruby
dir = File.expand_path(File.dirname(__FILE__) + '/../')
$:<< dir unless $:.include?(dir)

require 'rspec/expectations'
require 'rspec/matchers'
require 'lib/ole-regress.rb'
require 'csv'
require 'benchmark'

include OLE_QA::Profiler::Mixins
include OLE_QA::Profiler::Tests

FileUtils::mkdir('performance') unless File.directory?('performance')

csv_filename = "PerfomanceTest-#{Time.now.strftime('%Y-%m-%d-%I%M_%p')}.csv"

ole_start

results = []
results << ['Start Time',current_time]
results << ['URL',@ole.url]
results << ['Test Name','1st Run','2nd Run','3rd Run','4th Run','5th Run']

puts "#{'Test Name'.ljust(45)} #{'Start Time'.ljust(15)} Time Elapsed"


out = ['Portal Tab Sprint']
# Run Portal Tab Sprint test 5 times and gather times into results array.
5.times do
  test_name = 'Portal Tab Sprint'
  time_now  = current_time
  test_time = format_time(Benchmark.realtime {tab_sprint})
  puts "#{test_name.ljust(45)} #{time_now.ljust(15)} #{test_time}"
  out << test_time
end

results << out

out = ['Requisition Submission']
# Run Requisition Submission test 5 times and gather times into results array.
5.times do
  test_name = 'Requisition Submission'
  time_now  = current_time
  test_time = format_time(Benchmark.realtime {submit_req})
  puts "#{test_name.ljust(45)} #{time_now.ljust(15)} #{test_time}"
  out << test_time
end

results << out

ole_stop

CSV.open("performance/#{csv_filename}",'wb') do |csv|
  results.each do |line|
    csv << line
  end
end

puts "Results written to:\n  performance/#{csv_filename}"